<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>메뉴관리</title>
  <link href="css/styles2.css" rel="stylesheet"/>
  <script>
  // 현재 선택된 컴포넌트
  let dv;
  let num = 0;

  // 저장 데이터
  function saveTable(event, iRow) {
      let temp = document.getElementById('tempTable');
      let row;
      let cell;

      // 값이 변경되었을때도 들어가도록
      // 삭제가 되었을때 index 등...
      // 저장 알럿창

      if(event == "insert") {
          row = temp.insertRow();
          row.id = 'data_' + iRow.id;

          cell = row.insertCell(0);
          cell.innerHTML = '<input type=\"text\" name=\"menus[' + row.rowIndex + '].parentNum\" value=\"' + iRow.dataset.parentNum + '\"/>';
          cell = row.insertCell(1);
          cell.innerHTML = '<input type=\"text\" name=\"menus[' + row.rowIndex + '].depth\" value=\"' + iRow.dataset.depth + '\"/>';
          cell = row.insertCell(2);
          cell.innerHTML = '<input type=\"text\" name=\"menus[' + row.rowIndex + '].name\" value=\"' + iRow.dataset.name + '\"/>';
          cell = row.insertCell(3);
          cell.innerHTML = '<input type=\"text\" name=\"menus[' + row.rowIndex + '].path\" value=\"' + iRow.dataset.path + '\"/>';
      } else if(event == "delete") {
          if(document.getElementById('data_' + iRow.id) != null) {
              document.getElementById('data_' + iRow.id).remove();
          }
      }
  }

  // 메뉴 클릭
  function font_onclick() {
      let menuNameL = document.getElementById('menuNameL');
      let menuName = document.getElementById('menuName');
      let menuPathL = document.getElementById('menuPathL');
      let menuPath = document.getElementById('menuPath');
      let saveBtn = document.getElementById('saveBtn');

      // 이전에 선택한 컴포넌트 원상복구
      if(dv != null) {
          dv.style.color = 'black';
      }

      // 선택한 컴포넌트
      dv = event.currentTarget;

      // 선택한 컴포넌츠 색상 변경
      dv.style.color = 'blue';

      // 뎁스 0 : 폼 전체 숨김
      // 뎁스 1 : 메뉴명, 저장버튼 보이기
      // 뎁스 2 : 메뉴명, 경로, 저장버튼 보이기
      if(dv.dataset.depth == 2) {
        menuNameL.style.visibility = "visible";
        menuName.style.visibility = "visible";
        menuPathL.style.visibility = "visible";
        menuPath.style.visibility = "visible";
        //saveBtn.style.visibility = "visible";
      } else if(dv.dataset.depth == 1) {
        menuNameL.style.visibility = "visible";
        menuName.style.visibility = "visible";
        menuPathL.style.visibility = "hidden";
        menuPath.style.visibility = "hidden";
        //saveBtn.style.visibility = "visible";
      } else {
        menuNameL.style.visibility = "hidden";
        menuName.style.visibility = "hidden";
        menuPathL.style.visibility = "hidden";
        menuPath.style.visibility = "hidden";
        //saveBtn.style.visibility = "hidden";
      }

      menuName.value = dv.dataset.name;
  }

  // 메뉴 추가
  function fn_add() {
      // 메뉴 선택 필수
      if(dv == null) {
        alert('메뉴를 추가할 곳을 선택해주세요.');
        return false;
      // 뎁스 2 인경우 하위에 메뉴 추가 막기
      } else if(dv.dataset.depth == 2) {
        alert('마지막 메뉴입니다.');
        return false;
      // 신규 추가인 경우 하위 메뉴 추가 막기
      } else if(dv.dataset.status == 'new') {
        alert('저장 후 하위에 메뉴 추가가 가능합니다.');
        return false;
      }

      // 상위 메뉴 뎁스
      let parentDepth = dv.dataset.depth;

      // 테이블
      let table = document.getElementById('datatablesSimple');
      let row;
      let cell;

      // 뎁스 별 메뉴 모양
      if(parentDepth == 0) {
        row = table.insertRow();
        cell = row.insertCell(0);
        cell.innerText = 'ㅤ└ '  + '새 메뉴';
      } else if(parentDepth == 1) {
        row = table.insertRow(dv.rowIndex+1);
        cell = row.insertCell(0);
        cell.innerText = 'ㅤㅤ└ ' + '새 메뉴';
      }

      // 신규 추가 시 초기화
      row.addEventListener("click", () => { font_onclick(); });
      row.dataset.parentNum = dv.id;
      row.dataset.depth = Number(parentDepth)+1;
      row.dataset.path = '';
      row.dataset.name = '새 메뉴';
      row.dataset.status = 'new';
      row.id = 'new'+(num++);
      cell.style.cursor = 'pointer';
      cell.style.fontWeight = 'bold';

      saveTable('insert', row);
  }

  // 메뉴 삭제
  function fn_del() {
      // 테이블
      let table = document.getElementById('datatablesSimple');

      // 신규 추가인 경우 그냥 삭제
      if(dv == null) {
          alert("삭제할 메뉴를 선택해주세요.");
          return false;
      }

      if(dv.dataset.status == 'new') {
          table.deleteRow(dv.rowIndex);
          saveTable('delete', dv);
      // 기존 데이터인 경우 조건에 따라 처리
      } else {
          if(dv.dataset.depth == 0) {
              alert("대메뉴는 삭제할 수 없습니다.");
              return false;
          // 기존데이터 삭제의 경우 구분값을 주어 Service 에서 처리
          // 그러나 기존에 값이 존재하는 경우는 삭제못함
          // 삭제의 경우 색깔을 레드로 변경
          // 세이브테이블 저장 시 구분값이 필요할듯
          } else if(dv.dataset.depth == 1) {

              if(dv.dataset.childcnt != 0) {
                  alert("하위에 메뉴가 존재하는 경우 삭제가 불가능 합니다.");
                  return false;
              }

              dv.style.color = 'red';
              saveTable('insert', dv);
          } else {
              saveTable('insert', dv);
          }
      }

      dv = null;
  }

  // 저장
  function fn_save() {
      var menuForm = document.getElementById('menuForm');

      menuForm.submit();
  }

  </script>
</head>
<body>
<div id="div_menu" style="width:30%; float:left; height:100%;">
  <div class="card mb-4" style="width:100%; float:left; height:100%;">
    <div id="btnZone1" style="float:left; margin:5px 5px 5px 5px;">
      <nav style="float:right; display:inline-block;">
        <button class="button_2" onclick="fn_add();">추가</button>
        <button class="button_2" onclick="fn_del();">삭제</button>
      </nav>
    </div>
    <div class="card-body">
      <table id="datatablesSimple">
        <tbody>
          <tr th:each="menu : ${menu}" onclick="font_onclick();"
              th:id="${menu.id}"
              th:data-parentNum="${menu.parentNum}"
              th:data-depth="${menu.depth}"
              th:data-path="${menu.path}"
              th:data-name="${menu.name}"
              th:data-childcnt="${menu.childCnt}"
              th:data-status="default">
            <td style="cursor:pointer; font-weight:bold;" th:text="${menu.menuName}">
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<div style="width:1%; float:left;">ㅤ</div>
<div id="div_menu_detail" class="card mb-4" style="width:69%; height:100%; float:left; height:100%;">
  <div id="btnZone2" style="margin:5px 5px 5px 5px;">
    <nav style="float:right; display:inline-block;">
      <button class="button_2" id="saveBtn" onclick="fn_save(); return false;">저장</button>
    </nav>
  </div>
  <div class="card-body" id="menuInput">
      <lable id="menuNameL" style="visibility:hidden;">메뉴명 :</lable>
      <input type="text" name="name" id="menuName" style="visibility:hidden;">
      <br><br>
      <lable id="menuPathL" style="visibility:hidden;">경로 :</lable>
      <input type="text" name="path" id="menuPath" style="visibility:hidden;">
  </div>
  <form th:action="@{/menu/save}" method="post" id="menuForm">
    <table id="tempTable">
    </table>
  </form>
</div>
</body>
</html>